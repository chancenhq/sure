name: Build and push Docker image to ECR

on:
  push:
    tags:
    - 'v*'

env:
  ECR_REGISTRY: 568619624687.dkr.ecr.af-south-1.amazonaws.com
  ECR_REPOSITORY: sure
  RAW_GIT_TAG: ${{ github.ref_name }}
  AWS_REGION: "af-south-1"

permissions:
  id-token: write
  contents: read

jobs:
  docker-build-push:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: configure aws credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        role-to-assume: arn:aws:iam::568619624687:role/github-oidc-sure
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Normalize Docker image tag
      run: |
        # Strip only a single leading "v" (e.g. v0.6.8 -> 0.6.8)
        echo "DOCKER_IMAGE_TAG=${RAW_GIT_TAG#v}" >> "$GITHUB_ENV"

    - name: Build, tag, and push client docker image to Amazon ECR
      run: |
        docker buildx create --use
        docker buildx build --platform linux/arm64,linux/amd64 --push -t $ECR_REGISTRY/$ECR_REPOSITORY:$DOCKER_IMAGE_TAG .

    - uses: alexellis/arkade-get@master
      with:
        yq: latest

    - uses: actions/checkout@v4
      with:
        repository: chancenhq/platform-eks-production
        token: ${{ secrets.GH_PAT }}
        path: platform-eks-production

    - name: Update Deployment
      run: |
        RAW_TAG="${RAW_GIT_TAG:?RAW_GIT_TAG is required}"
        IMAGE_TAG="${DOCKER_IMAGE_TAG:?DOCKER_IMAGE_TAG is required}"

        # Stricter semver-like prerelease match: vMAJOR.MINOR.PATCH[-alpha.X|-beta.X]
        is_alpha='^v[0-9]+(\.[0-9]+)*-alpha([.-][0-9]+)?$'
        is_beta='^v[0-9]+(\.[0-9]+)*-beta([.-][0-9]+)?$'

        if [[ "$RAW_TAG" =~ $is_beta ]]; then
          echo "Beta tag detected: $RAW_TAG"
          # [future] Deploy Sure
          # yq -i '.sure.image.tag = "${{ env.DOCKER_IMAGE_TAG }}"' platform-eks-production/apps/sure/values.yaml
          # Deploy Companion (staging)
          yq -i '.companion.image.tag = "${{ env.DOCKER_IMAGE_TAG }}"' platform-eks-production/apps/companion-staging/values.yaml

        elif [[ "$RAW_TAG" =~ $is_alpha ]]; then
          echo "Alpha tag detected: $RAW_TAG"
          # Deploy Sure only
          yq -i '.sure.image.tag = "${{ env.DOCKER_IMAGE_TAG }}"' platform-eks-production/apps/sure/values.yaml

        else
          echo "Tag '$RAW_TAG' does not match alpha/beta patterns. No deployment."
        fi

        # Stage changes
        git -C platform-eks-production add -A
        
        # Exit 0 if no diff vs HEAD; nonzero if there are changes
        if git -C platform-eks-production diff-index --quiet HEAD --; then
          echo "No changes to commit."
        else
          git config --global user.email "platform@chancen.international"
          git config --global user.name "platform-chancen"
          git config --global credential.helper cache        
          git -C platform-eks-production commit -m "Update ${ECR_REPOSITORY:-unknown} image tag to ${IMAGE_TAG}"
          git -C platform-eks-production push
        fi
